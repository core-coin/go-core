name: go-core build
on: [push, pull_request]
jobs:
  build:
    strategy:
      matrix:
        platform: [ubuntu-latest]
    runs-on: ${{ matrix.platform }}
    steps:
    - name: Setup
      uses: actions/setup-go@v1
      with:
        go-version: 1.14.x
      id: go
    - name: Checkout
      uses: actions/checkout@v1
    - name: Build
      run: go run build/ci.go install
    - name: Test
      run: go run build/ci.go test
  debian:
    name: debian
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Checkout
      uses: actions/checkout@v1
    - name: Tag
      id: vars
      run: echo ::set-output name=tag::$(echo ${GITHUB_REF:10})
    - name: Version
      run: sed -i 's/#TAG#/${{steps.vars.outputs.tag}}/g' params/version.go
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v3
      with:
        gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.PASSPHRASE }}
    - name: Import SSH key
      uses: webfactory/ssh-agent@v0.4.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    - name: setup debuild
      run: sudo apt-get install build-essential fakeroot devscripts dh-make
    - name: run debuild
      run: go run build/ci.go debsrc -goversion 1.14.6 -signer "core-coin robot <sashaz@corecoin.cc>" -upload core-coin/go-core
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  docker:
    name: docker
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [build, debian]
    steps:
    - name: Checkout
      uses: actions/checkout@v1
    - name: Tag
      id: vars
      run: echo ::set-output name=tag::$(echo ${GITHUB_REF:10})
    - name: Version
      run: sed -i 's/#TAG#/${{steps.vars.outputs.tag}}/g' params/version.go
    - name: docker login
      run: docker login docker.pkg.github.com -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
    - name: docker build
      run: docker build . -f Dockerfile -t docker.pkg.github.com/core-coin/go-core/gocore:${{steps.vars.outputs.tag}} -t docker.pkg.github.com/core-coin/go-core/gocore:latest
    - name: docker push latest version
      run: docker push docker.pkg.github.com/core-coin/go-core/gocore:latest
    - name: docker push current version
      run: docker push docker.pkg.github.com/core-coin/go-core/gocore:${{steps.vars.outputs.tag}}
